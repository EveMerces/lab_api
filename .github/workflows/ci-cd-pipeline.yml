name: CI/CD Pipeline - Lab API (Railway)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:

  build:
    name: Build e Preparacao
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do codigo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "Dependencias instaladas"

      - name: Verificar estrutura
        run: |
          ls -la
          echo "Estrutura ok"

      - name: Build da imagem Docker
        run: |
          docker build -t lab-api:${{ github.sha }} .
          docker tag lab-api:${{ github.sha }} lab-api:latest
          echo "Docker build ok"

  test:
    name: Testes Unitarios
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout do codigo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Instalar dependencias
        run: |
          pip install -r requirements.txt

      - name: Executar testes
        run: |
          python -m unittest discover -v

  deploy:
    name: Deploy para Railway
    runs-on: ubuntu-latest
    needs: test
    if: success()

    steps:
      - name: Checkout do codigo
        uses: actions/checkout@v4

      - name: Instalar Railway CLI
        run: |
          npm install -g @railway/cli
          echo "Railway CLI instalada"

      - name: Configurar token
        run: echo "Token carregado"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Executar deploy
        run: |
          railway up --project 9cb80052-a5b4-443d-8e79-981fd17cc0e1 --service lab_api
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Finalizacao
        run: echo "Pipeline concluida com sucesso"
